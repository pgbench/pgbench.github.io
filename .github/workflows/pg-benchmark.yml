name: PostgreSQL Benchmark

on:
  workflow_call:
    inputs:
      pg_version:
        description: 'PostgreSQL version to benchmark'
        required: true
        type: string

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    env:
      PG_VERSION: ${{ inputs.pg_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PostgreSQL ${{ env.PG_VERSION }}
        uses: tj-actions/install-postgresql@v3
        with:
          postgresql-version: ${{ env.PG_VERSION }}

      - name: Run PgBench
        run: |
          git pull
          sudo systemctl start postgresql.service
          sudo -u postgres psql -c "CREATE USER test_user WITH PASSWORD 'test_password' CREATEDB;"

          # Get PostgreSQL full version
          PG_FULL_VERSION=$(sudo -u postgres psql -c "select version();" )

          # Create benchmark markdown file
          cat << EOF > hugosite/content/pg${PG_VERSION}.md
          +++
          date = '$(date +%Y-%m-%dT%H:%M:%S%z)'
          draft = false
          title = 'PostgreSQL ${PG_VERSION} Benchmark Results'
          +++

          ## PgBench Results for PostgreSQL ${PG_VERSION}

          ### PostgreSQL Version
          \`\`\`
          ${PG_FULL_VERSION}
          \`\`\`

          ### System Information
          \`\`\`
          $(lscpu | grep -E '^(Model name|CPU\(s\)|Thread|CPU MHz)')
          Memory: $(free -h | grep Mem | awk '{print $2}')
          \`\`\`

          EOF

          # Initialize and run benchmark
          sudo -u postgres pgbench -i 

          echo "### Benchmark Results" >> hugosite/content/pg${PG_VERSION}.md
          echo "\`\`\`" >> hugosite/content/pg${PG_VERSION}.md
          sudo -u postgres pgbench -c 16 -j 4 -T 60 -P 5 -U postgres postgres 2>&1 | tee >(cat >> hugosite/content/pg${PG_VERSION}.md)
          echo "\`\`\`" >> hugosite/content/pg${PG_VERSION}.md

      - name: Commit benchmark results
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update PostgreSQL ${{ env.PG_VERSION }} benchmark results"
          file_pattern: 'hugosite/content/pg${{ env.PG_VERSION }}.md'
